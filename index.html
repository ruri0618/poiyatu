<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ハロプロ モバガチャ2025</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background-color: #000; color: #fff; }
    .group-buttons { margin-bottom: 20px; }
    .group-buttons button { margin: 5px; padding: 10px 15px; font-size: 14px; cursor: pointer; }
    .video-frame {
        width: 135%; max-width: 900px; aspect-ratio: 16/9;
        background: #000; position: relative; overflow: visible;
        margin: 0 auto 120px; display: block;
    }
    .video-frame video { width: 100%; height: 100%; object-fit: cover; z-index: 0; position: relative; }
    .overlay {
        position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        font-size:30px; font-weight:bold; color:#fff; text-shadow:2px 2px 4px #000;
        white-space:pre-line; pointer-events:none; opacity:0; transition:opacity 1s; z-index:2;
    }
    .counter-overlay {
        position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
        background:rgba(0,0,0,0.6); color:#fff; padding:6px 12px; border-radius:8px; font-size:16px; z-index:2;
    }
    .video-controls {
        position:absolute; bottom:-60px; left:50%; transform:translateX(-50%); z-index:2;
    }
    .video-controls button {
        margin:0 8px; padding:8px 16px; font-size:14px; cursor:pointer;
    }
    .white-text { color:white; }
    .gold-text  { color:gold; }
    .rainbow-text {
        background: linear-gradient(to right, red, orange, yellow, green, cyan, blue, violet);
        -webkit-background-clip: text; color:transparent;
        animation: rainbow 3s infinite;
    }
    @keyframes rainbow {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
    }
    #history {
        display:none; margin:20px auto; max-width:600px;
        background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; text-align:left;
    }
    /* モーダル */
    #itemModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      align-items: center; justify-content: center;
      z-index: 999;
    }
    #itemModal .modal-content {
      background: #222; padding: 20px; border-radius:8px;
      width: 90%; max-width: 500px; color: #fff; text-align: left;
    }
    #itemModal h2 { margin-top: 0; font-size: 20px; }
    .item-group { margin-bottom: 16px; }
    .item-group h3 { margin-bottom: 8px; font-size: 16px; }
    .item-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .item-list input {
      flex: 1 1 45%; padding: 6px 8px; border:1px solid #444; border-radius:4px;
      background: #333; color: #fff;
    }
    .item-group button.add { margin-top: 4px; padding:4px 8px; font-size:12px; cursor:pointer; }
    .modal-actions { text-align: right; margin-top: 12px; }
    .modal-actions button {
      margin-left: 8px; padding:6px 12px; font-size:14px; cursor:pointer;
    }
</style>
</head>
<body>

<h1>✨ハロプロモバガチャ 2025 ミニアプリ✨</h1>

<!-- グループ選択ボタン -->
<div class="group-buttons">
  <button onclick="selectGroup('all')">全員</button>
  <button onclick="selectGroup('momusu')">モーニング娘。</button>
  <button onclick="selectGroup('angerme')">アンジュルム</button>
  <button onclick="selectGroup('juice')">Juice=Juice</button>
  <button onclick="selectGroup('tsubaki')">つばきファクトリー</button>
  <button onclick="selectGroup('beyooooonds')">BEYOOOOONDS</button>
  <button onclick="selectGroup('ocha')">OCHA NORMA</button>
  <button onclick="selectGroup('rose')">ロージークロニクル</button>
</div>

<div class="video-frame">
  <video id="gachaVideo" src="scene_1.mp4" autoplay loop muted playsinline></video>
  <div id="overlay" class="overlay"></div>
  <div id="counter" class="counter-overlay"></div>
  <div class="video-controls">
    <button id="showHistoryButton">獲得アイテム一覧</button>
    <button id="editItemsButton">出現アイテム編集</button>
    <button id="resetButton">リセット</button>
  </div>
</div>

<div id="history"></div>

<!-- アイテム編集モーダル -->
<div id="itemModal">
  <div class="modal-content">
    <h2>出現アイテム編集</h2>

    <div class="item-group" data-rarity="N">
      <h3>Nアイテム</h3>
      <div class="item-list" id="list-N"></div>
      <button class="add" data-rarity="N">＋Nアイテムを追加</button>
    </div>

    <div class="item-group" data-rarity="R">
      <h3>Rアイテム</h3>
      <div class="item-list" id="list-R"></div>
      <button class="add" data-rarity="R">＋Rアイテムを追加</button>
    </div>

    <div class="item-group" data-rarity="SR">
      <h3>SRアイテム</h3>
      <div class="item-list" id="list-SR"></div>
      <button class="add" data-rarity="SR">＋SRアイテムを追加</button>
    </div>

    <!-- ★スペシャル対象メンバー入力欄を追加 -->
    <div class="item-group">
      <h3>スペシャル対象メンバー</h3>
      <textarea id="specialMembersInput" placeholder="例: 小田さくら, 上國料萌衣" rows="3" style="width:100%; background:#333; color:white; border:1px solid #444; border-radius:4px; padding:6px;"></textarea>
    </div>

    <div class="modal-actions">
      <button id="cancelEdit">キャンセル</button>
      <button id="saveEdit">保存</button>
    </div>
  </div>
</div>

<script>
//―――― 初期データ定義
const groups = {
  all: [...], // （ここはあなたの元データと同じ）
  momusu: [...],
  angerme: [...],
  juice: [...],
  tsubaki: [...],
  beyooooonds: [...],
  ocha: [...],
  rose: [...]
};
let members = groups.all;

let counts = { SR:0, R:0, N:0 };
let history = [];
let specialMembers = [];  // ★追加
const rarities = [
  { type:"N", rate:65 },
  { type:"R", rate:30 },
  { type:"SR",rate:5 }
];
let itemsConfig = { N:["缶バッジ","ステッカー"], R:["キーホルダー"], SR:["BIGアクリルスタンド"] };

const videoEl   = document.getElementById("gachaVideo");
const overlayEl = document.getElementById("overlay");
const counterEl = document.getElementById("counter");
const histEl    = document.getElementById("history");

function selectGroup(g){ members = groups[g]; }
function updateCounter(){ counterEl.innerText = `SR:${counts.SR}個 / R:${counts.R}個 / N:${counts.N}個`; }
function getRandomRarity(){ let r=Math.random()*100, sum=0; for(let x of rarities){ sum+=x.rate; if(r<=sum) return x.type; } return rarities[rarities.length-1].type; }

//―――― drawGacha改修版
function drawGacha() {
  const rarity = getRandomRarity();
  const itemArr = itemsConfig[rarity];
  
  let candidateItems = [];

  for (const member of members) {
    for (const item of itemArr) {
      candidateItems.push({ member, item, isSpecial: false });
      if (specialMembers.includes(member)) {
        candidateItems.push({ member, item: item + "（スペシャルVer）", isSpecial: true });
      }
    }
  }

  const chosen = candidateItems[Math.floor(Math.random() * candidateItems.length)];

  let textClass = "white-text";
  if (rarity === "R") textClass = "gold-text";
  if (rarity === "SR") textClass = "rainbow-text";
  if (chosen.isSpecial) textClass = "rainbow-text";

  const displayText = `<div class="${textClass}">${chosen.member}\n${rarity}-${chosen.item}</div>`;

  videoEl.src = "scene_2.mp4";
  videoEl.loop = false;
  overlayEl.style.opacity = 0;
  overlayEl.innerHTML = "";

  videoEl.onended = () => {
    videoEl.src = rarity === "SR" ? "scene_3_rarity_A.mp4"
              : rarity === "R"  ? "scene_3_rarity_B.mp4"
              :                   "scene_3_rarity_C.mp4";
    videoEl.loop = true;
    videoEl.play();

    setTimeout(() => {
      overlayEl.innerHTML = displayText;
      overlayEl.style.opacity = 1;
      counts[rarity]++;
      history.push({ member: chosen.member, rarity, item: chosen.item });
      updateCounter();
    }, 200);
  };
  videoEl.play();
}

//―――― イベント登録
videoEl.addEventListener("click", drawGacha);

document.getElementById("showHistoryButton").addEventListener("click", ()=>{
  histEl.style.display = histEl.style.display==="block"?"none":"block";
  if(histEl.style.display==="block"){
    histEl.innerHTML = history.map(h=>{
      const cls = h.item.includes("（スペシャルVer）") ? "rainbow-text"
                : h.rarity==="SR" ? "rainbow-text"
                : h.rarity==="R"  ? "gold-text"
                : "white-text";
      return `<div class="${cls}">${h.member}: ${h.rarity}-${h.item}</div>`;
    }).join("");
  }
});
document.getElementById("resetButton").addEventListener("click", ()=>{
  counts={SR:0,R:0,N:0}; history=[]; updateCounter(); histEl.style.display="none"; histEl.innerHTML="";
});
updateCounter();

//―――― モーダル処理
const modal=document.getElementById("itemModal"),
      btnEdit=document.getElementById("editItemsButton"),
      btnSave=document.getElementById("saveEdit"),
      btnCancel=document.getElementById("cancelEdit");

function populateModal(){
  ["N","R","SR"].forEach(rty=>{
    const cont=document.getElementById(`list-${rty}`);
    cont.innerHTML="";
    itemsConfig[rty].forEach(name=>{
      const inp=document.createElement("input");
      inp.value=name;
      cont.appendChild(inp);
    });
  });
  document.getElementById("specialMembersInput").value = specialMembers.join(", ");
}

document.querySelectorAll("#itemModal .add").forEach(btn=>
  btn.addEventListener("click", ()=>{
    const r=btn.dataset.rarity;
    const inp=document.createElement("input");
    inp.placeholder="アイテム名を入力";
    document.getElementById(`list-${r}`).appendChild(inp);
  })
);

btnEdit.addEventListener("click", ()=>{
  populateModal();
  modal.style.display="flex";
});
btnCancel.addEventListener("click", ()=>{ modal.style.display="none"; });
btnSave.addEventListener("click", ()=>{
  ["N","R","SR"].forEach(rty=>{
    const vals=Array.from(document.querySelectorAll(`#list-${rty} input`))
      .map(i=>i.value.trim())
      .filter(v=>v);
    if(vals.length) itemsConfig[rty]=vals;
  });

  const spInput = document.getElementById("specialMembersInput").value;
  specialMembers = spInput.split(/[\n,、,]+/).map(name=>name.trim()).filter(name=>name);

  modal.style.display="none";
  alert("出現アイテム設定を更新しました！");
});
</script>

</body>
</html>
